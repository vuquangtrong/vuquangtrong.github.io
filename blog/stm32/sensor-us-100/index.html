
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="US-100 is one of popular distance sensor used in many projects. It has ranging distance up to 450 cm with 1 mm resolution in less then 15 degree of view angle. It also has temperature sensor to compensate the result. The US-100 is very similar to the popular HC-SR04 ultrasonic sensors, but it provides UART interface beside the Pulse Width mode." name="description"/>
<meta content="embedded systems application programming" name="keywords"/>
<meta content="vqtrong" name="author"/>
<link href="https://www.codeinsideout.com/blog/stm32/sensor-us-100/" rel="canonical"/>
<link href="../../../favicon.png" rel="icon"/>
<meta content="mkdocs-1.2.2, mkdocs-material-7.2.4" name="generator"/>
<title>US-100 - Ultrasonic distance sensor - Code Inside Out</title>
<link href="../../../assets/stylesheets/main.f7f47774.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.3f5d1f46.min.css" rel="stylesheet"/>
<meta content="#ffffff" name="theme-color"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Noto+Serif:300,400,400i,700%7CRoboto+Mono&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font-family:"Noto Serif";--md-code-font-family:"Roboto Mono"}</style>
<link href="../../../assets/view-bigimg.css" rel="stylesheet"/>
<link href="../../../assets/extra.css" rel="stylesheet"/>
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-42618265-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
<meta content="website" property="og:type">
<meta content="US-100 - Ultrasonic distance sensor - Code Inside Out" property="og:title">
<meta content="US-100 is one of popular distance sensor used in many projects. It has ranging distance up to 450 cm with 1 mm resolution in less then 15 degree of view angle. It also has temperature sensor to compensate the result. The US-100 is very similar to the popular HC-SR04 ultrasonic sensors, but it provides UART interface beside the Pulse Width mode." property="og:description">
<meta content="https://www.codeinsideout.com/blog/stm32/sensor-us-100/" property="og:url">
<meta content="https://www.codeinsideout.com/assets/banner.jpg" property="og:image">
<meta content="Code Inside Out" property="og:site_name">
<meta content="summary" name="twitter:card">
</meta></meta></meta></meta></meta></meta></meta></head>
<body data-md-color-accent="deep-orange" data-md-color-primary="white" data-md-color-scheme="" dir="ltr">
<script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#1-us-100-ultrasonic-sensor">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Code Inside Out" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="Code Inside Out">
<svg viewbox="0 0 640 512" xmlns="http://www.w3.org/2000/svg"><path d="m278.9 511.5-61-17.7c-6.4-1.8-10-8.5-8.2-14.9L346.2 8.7c1.8-6.4 8.5-10 14.9-8.2l61 17.7c6.4 1.8 10 8.5 8.2 14.9L293.8 503.3c-1.9 6.4-8.5 10.1-14.9 8.2zm-114-112.2 43.5-46.4c4.6-4.9 4.3-12.7-.8-17.2L117 256l90.6-79.7c5.1-4.5 5.5-12.3.8-17.2l-43.5-46.4c-4.5-4.8-12.1-5.1-17-.5L3.8 247.2c-5.1 4.7-5.1 12.8 0 17.5l144.1 135.1c4.9 4.6 12.5 4.4 17-.5zm327.2.6 144.1-135.1c5.1-4.7 5.1-12.8 0-17.5L492.1 112.1c-4.8-4.5-12.4-4.3-17 .5L431.6 159c-4.6 4.9-4.3 12.7.8 17.2L523 256l-90.6 79.7c-5.1 4.5-5.5 12.3-.8 17.2l43.5 46.4c4.5 4.9 12.1 5.1 17 .6z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Code Inside Out
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              US-100 Sensor
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-tabs__inner md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../..">
      Home
    </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link md-tabs__link--active" href="../../">
      Blog
    </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../projects/">
      Projects
    </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../tags/">
      Tags
    </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<style>
        .md-sidebar {
            opacity: 0.2;
        }
        .md-sidebar:hover {
            opacity: 1;
        }
    </style>
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Code Inside Out" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="Code Inside Out">
<svg viewbox="0 0 640 512" xmlns="http://www.w3.org/2000/svg"><path d="m278.9 511.5-61-17.7c-6.4-1.8-10-8.5-8.2-14.9L346.2 8.7c1.8-6.4 8.5-10 14.9-8.2l61 17.7c6.4 1.8 10 8.5 8.2 14.9L293.8 503.3c-1.9 6.4-8.5 10.1-14.9 8.2zm-114-112.2 43.5-46.4c4.6-4.9 4.3-12.7-.8-17.2L117 256l90.6-79.7c5.1-4.5 5.5-12.3.8-17.2l-43.5-46.4c-4.5-4.8-12.1-5.1-17-.5L3.8 247.2c-5.1 4.7-5.1 12.8 0 17.5l144.1 135.1c4.9 4.6 12.5 4.4 17-.5zm327.2.6 144.1-135.1c5.1-4.7 5.1-12.8 0-17.5L492.1 112.1c-4.8-4.5-12.4-4.3-17 .5L431.6 159c-4.6 4.9-4.3 12.7.8 17.2L523 256l-90.6 79.7c-5.1 4.5-5.5 12.3-.8 17.2l43.5 46.4c4.5 4.9 12.1 5.1 17 .6z"></path></svg>
</a>
    Code Inside Out
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
        Home
      </a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../../" style="margin: initial; padding: initial; pointer-events: initial">
        
          Blog
        </a>
</label>
<nav aria-label="Blog" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../../" style="margin: initial; padding: initial; pointer-events: initial">
          
            Blog
          </a>
</label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" id="__nav_2_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_1">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../" style="margin: initial; padding: initial; pointer-events: initial">
        
          STM32
        </a>
</label>
<nav aria-label="STM32" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_1">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../" style="margin: initial; padding: initial; pointer-events: initial">
          
            STM32
          </a>
</label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../intro/">
        Introduction
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../prepare/">
        Preparation
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../tools/">
        Toolchain
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../docs/">
        Documents
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../clock/">
        Clock Tree
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../interrupt/">
        Interrupt
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../semihosting/">
        SemiHosting
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../gpio/">
        GPIO
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../dma/">
        DMA
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../swv/">
        SWV
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../add-swo/">
        Add SWO
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../uart/">
        UART
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../uart-redirection/">
        UART Redirection
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../timer/">
        Timers
      </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link md-nav__link--active" href="./" style="margin: initial; padding: initial; pointer-events: initial">
          
            US-100 Sensor
          </a>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
        US-100 Sensor
      </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-us-100-ultrasonic-sensor">
    1. US-100 Ultrasonic sensor
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-lab-1-uart-mode">
    2. Lab 1: UART mode
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-lab-2-pulse-mode">
    3. Lab 2: Pulse mode
  </a>
<nav aria-label="3. Lab 2: Pulse mode" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#31-methods-to-read-a-pulse-width">
    3.1. Methods to read a pulse width.
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#32-use-input-capture">
    3.2. Use Input Capture
  </a>
<nav aria-label="3.2. Use Input Capture" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#321-enable-timer-and-input-capture">
    3.2.1. Enable Timer and Input Capture
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#322-generated-code">
    3.2.2. Generated code
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#323-user-code">
    3.2.3. User code
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../adc/">
        ADC
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../i2c-spi/">
        I2C - SPI
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../oled-ssd1306/">
        SSD1306 OLED
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_19" id="__nav_2_1_19" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_1_19">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../free-rtos/overview/" style="margin: initial; padding: initial; pointer-events: initial">
        
          FreeRTOS
        </a>
</label>
<nav aria-label="FreeRTOS" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_1_19">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../free-rtos/overview/" style="margin: initial; padding: initial; pointer-events: initial">
          
            FreeRTOS
          </a>
</label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../free-rtos/systick/">
        SysTick &amp; Delay
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../free-rtos/memory/">
        Memory
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../free-rtos/interrupt/">
        Interrupt
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../free-rtos/tasks/">
        Tasks
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../free-rtos/reentrant/">
        Reentrant
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../free-rtos/stack/">
        Stack Overflow
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../j-link-rtt/">
        J-Link RTT
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../j-link-sysview/">
        J-Link SysView
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../notes/">
        Notes
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" id="__nav_2_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_2">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../../pi/" style="margin: initial; padding: initial; pointer-events: initial">
        
          Raspberry Pi
        </a>
</label>
<nav aria-label="Raspberry Pi" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_2">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../../pi/" style="margin: initial; padding: initial; pointer-events: initial">
          
            Raspberry Pi
          </a>
</label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../pi/headless-mode/">
        Headless mode
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../pi/compile-ffmpeg/">
        Compile FFmpeg
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../pi/resource-usage/">
        Resource usage
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../pi/setup-camera/">
        Setup Camera
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../pi/stream-ffmpeg-hls-dash/">
        HLS/DASH Streaming
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../pi/stream-picamera-mjpeg/">
        MJPEG streaming
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../pi/stream-picamera-h264/">
        H264 streaming
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../pi/backup-sdcard/">
        Backup SDCard
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../pi/check-camera-i2c/">
        Diagnostic Camera
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../pi/ubuntu/">
        Ubuntu
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../pi/notes/">
        Notes
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" id="__nav_2_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_3">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../../c-cpp/" style="margin: initial; padding: initial; pointer-events: initial">
        
          C/C++
        </a>
</label>
<nav aria-label="C/C++" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_3">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../../c-cpp/" style="margin: initial; padding: initial; pointer-events: initial">
          
            C/C++
          </a>
</label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../c-cpp/notes/">
        Notes
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4" id="__nav_2_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_4">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../../gnss/" style="margin: initial; padding: initial; pointer-events: initial">
        
          GNSS
        </a>
</label>
<nav aria-label="GNSS" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_4">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../../gnss/" style="margin: initial; padding: initial; pointer-events: initial">
          
            GNSS
          </a>
</label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4_1" id="__nav_2_4_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_4_1">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../../gnss/unicorecomm/" style="margin: initial; padding: initial; pointer-events: initial">
        
          Unicorecomm
        </a>
</label>
<nav aria-label="Unicorecomm" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_4_1">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../../gnss/unicorecomm/" style="margin: initial; padding: initial; pointer-events: initial">
          
            Unicorecomm
          </a>
</label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../gnss/unicorecomm/ub4xx/">
        UB482/UB4B0M
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_5" id="__nav_2_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_5">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../../imu/" style="margin: initial; padding: initial; pointer-events: initial">
        
          IMU
        </a>
</label>
<nav aria-label="IMU" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_5">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../../imu/" style="margin: initial; padding: initial; pointer-events: initial">
          
            IMU
          </a>
</label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_5_1" id="__nav_2_5_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_5_1">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../../imu/invensense/" style="margin: initial; padding: initial; pointer-events: initial">
        
          InvenSense
        </a>
</label>
<nav aria-label="InvenSense" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_2_5_1">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../../imu/invensense/" style="margin: initial; padding: initial; pointer-events: initial">
          
            InvenSense
          </a>
</label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../imu/invensense/dk-20789/">
        DK-20789
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_6" id="__nav_2_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_6">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../../lidar/" style="margin: initial; padding: initial; pointer-events: initial">
        
          LIDAR
        </a>
</label>
<nav aria-label="LIDAR" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_6">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../../lidar/" style="margin: initial; padding: initial; pointer-events: initial">
          
            LIDAR
          </a>
</label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../lidar/livox-sdk/">
        Livox SDK
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../lidar/livox-mapping-apx15/">
        Livox high precision mapping
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_7" id="__nav_2_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_7">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../../linux/" style="margin: initial; padding: initial; pointer-events: initial">
        
          Linux
        </a>
</label>
<nav aria-label="Linux" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_7">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../../linux/" style="margin: initial; padding: initial; pointer-events: initial">
          
            Linux
          </a>
</label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../linux/byobu/">
        Byobu
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../linux/dual-boot/">
        Dual Boot
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../linux/samba/">
        Samba
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../linux/tweaks/">
        Tweaks
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_8" id="__nav_2_8" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_8">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../../ros/" style="margin: initial; padding: initial; pointer-events: initial">
        
          ROS
        </a>
</label>
<nav aria-label="ROS" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_8">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../../ros/" style="margin: initial; padding: initial; pointer-events: initial">
          
            ROS
          </a>
</label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../ros/tutorial-beginner/">
        Tutorial for Beginners
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_9" id="__nav_2_9" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_9">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../../setup-blog/" style="margin: initial; padding: initial; pointer-events: initial">
        
          Setup blog
        </a>
</label>
<nav aria-label="Setup blog" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_9">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../../setup-blog/" style="margin: initial; padding: initial; pointer-events: initial">
          
            Setup blog
          </a>
</label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup-blog/markdown-syntax/">
        Markdown syntax
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup-blog/mkdocs-plugins/">
        MkDocs plugins
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup-blog/customize-theme/">
        Customize theme
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup-blog/print-to-pdf/">
        Print to PDF
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup-blog/fix-ajax-issue/">
        Fix AJAX issue
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_10" id="__nav_2_10" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_10">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../../virtual-machine/" style="margin: initial; padding: initial; pointer-events: initial">
        
          Virtual machine
        </a>
</label>
<nav aria-label="Virtual machine" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_10">
<span class="md-nav__icon md-icon"></span>
<a class="md-nav__link" href="../../virtual-machine/" style="margin: initial; padding: initial; pointer-events: initial">
          
            Virtual machine
          </a>
</label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../virtual-machine/docker/">
        Docker
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../virtual-machine/hyper-v/">
        Hyper-V
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../projects/">
        Projects
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../tags/">
        Tags
      </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-us-100-ultrasonic-sensor">
    1. US-100 Ultrasonic sensor
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-lab-1-uart-mode">
    2. Lab 1: UART mode
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-lab-2-pulse-mode">
    3. Lab 2: Pulse mode
  </a>
<nav aria-label="3. Lab 2: Pulse mode" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#31-methods-to-read-a-pulse-width">
    3.1. Methods to read a pulse width.
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#32-use-input-capture">
    3.2. Use Input Capture
  </a>
<nav aria-label="3.2. Use Input Capture" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#321-enable-timer-and-input-capture">
    3.2.1. Enable Timer and Input Capture
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#322-generated-code">
    3.2.2. Generated code
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#323-user-code">
    3.2.3. User code
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
<div class="tag-cloud-toc">
<p class="md-nav" style="margin-bottom: 0.5em;">
<label class="md-nav__title">Tag cloud</label>
</p>
<div class="tag-cloud-content">
<a class="tag" href="https://www.codeinsideout.com/tags/#jinja">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkCyan;
        ">jinja</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#ffmpeg">
<span class="tag-name" style="
          font-size:0.6rem;
          color:DarkOrchid;
        ">ffmpeg</span>
<!--<sup class="tag-count">2</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#performance">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkOliveGreen;
        ">performance</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#dash">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkSlateGray;
        ">dash</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#ins">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkGreen;
        ">ins</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#stream">
<span class="tag-name" style="
          font-size:0.65rem;
          color:DarkGreen;
        ">stream</span>
<!--<sup class="tag-count">3</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#i2c">
<span class="tag-name" style="
          font-size:0.6rem;
          color:DarkOliveGreen;
        ">i2c</span>
<!--<sup class="tag-count">2</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#hyper-v">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkMagenta;
        ">hyper-v</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#toolchain">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkSlateGray;
        ">toolchain</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#lidar">
<span class="tag-name" style="
          font-size:0.6rem;
          color:DarkCyan;
        ">lidar</span>
<!--<sup class="tag-count">2</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#timer">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkViolet;
        ">timer</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#gps">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkGoldenrod;
        ">gps</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#mjpeg">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkRed;
        ">mjpeg</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#v4l2">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkGreen;
        ">v4l2</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#sharing">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkCyan;
        ">sharing</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#ajax">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkTurquoise;
        ">ajax</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#hls">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkOrchid;
        ">hls</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#raspberry-pi">
<span class="tag-name" style="
          font-size:1.05rem;
          color:DarkRed;
        ">raspberry-pi</span>
<!--<sup class="tag-count">11</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#material">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkBlue;
        ">material</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#markdown">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkSlateBlue;
        ">markdown</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#gnss">
<span class="tag-name" style="
          font-size:0.6rem;
          color:DarkTurquoise;
        ">gnss</span>
<!--<sup class="tag-count">2</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#sensor">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkGoldenrod;
        ">sensor</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#libs">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkTurquoise;
        ">libs</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#picamera">
<span class="tag-name" style="
          font-size:0.65rem;
          color:DarkSlateGray;
        ">picamera</span>
<!--<sup class="tag-count">3</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#debug">
<span class="tag-name" style="
          font-size:0.75rem;
          color:DarkViolet;
        ">debug</span>
<!--<sup class="tag-count">5</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#clock">
<span class="tag-name" style="
          font-size:0.6rem;
          color:DarkCyan;
        ">clock</span>
<!--<sup class="tag-count">2</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#spi">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkViolet;
        ">spi</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#headless">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkViolet;
        ">headless</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#linux">
<span class="tag-name" style="
          font-size:0.75rem;
          color:DarkViolet;
        ">linux</span>
<!--<sup class="tag-count">5</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#rtos">
<span class="tag-name" style="
          font-size:0.75rem;
          color:DarkGreen;
        ">rtos</span>
<!--<sup class="tag-count">5</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#oled">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkGreen;
        ">oled</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#memory">
<span class="tag-name" style="
          font-size:0.6rem;
          color:DarkGreen;
        ">memory</span>
<!--<sup class="tag-count">2</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#h264">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkCyan;
        ">h264</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#virtual-machine">
<span class="tag-name" style="
          font-size:0.6rem;
          color:DarkSlateGray;
        ">virtual-machine</span>
<!--<sup class="tag-count">2</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#uart">
<span class="tag-name" style="
          font-size:0.65rem;
          color:DarkMagenta;
        ">uart</span>
<!--<sup class="tag-count">3</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#javascript">
<span class="tag-name" style="
          font-size:0.6rem;
          color:DarkSlateBlue;
        ">javascript</span>
<!--<sup class="tag-count">2</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#docker">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkOliveGreen;
        ">docker</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#c/c++">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkTurquoise;
        ">c/c++</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#stm32">
<span class="tag-name" style="
          font-size:1.8rem;
          color:DarkRed;
        ">stm32</span>
<!--<sup class="tag-count">26</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#redirect">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkGreen;
        ">redirect</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#sdcard">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkOliveGreen;
        ">sdcard</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#camera">
<span class="tag-name" style="
          font-size:0.8rem;
          color:DarkBlue;
        ">camera</span>
<!--<sup class="tag-count">6</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#adc">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkTurquoise;
        ">adc</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#reentrant">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkTurquoise;
        ">reentrant</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#imu">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkRed;
        ">imu</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#html">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkRed;
        ">html</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#mapping">
<span class="tag-name" style="
          font-size:0.6rem;
          color:DarkSlateGray;
        ">mapping</span>
<!--<sup class="tag-count">2</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#pdf">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkGoldenrod;
        ">pdf</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#container">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkBlue;
        ">container</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#interrupt">
<span class="tag-name" style="
          font-size:0.65rem;
          color:DarkViolet;
        ">interrupt</span>
<!--<sup class="tag-count">3</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#notes">
<span class="tag-name" style="
          font-size:0.7rem;
          color:DarkViolet;
        ">notes</span>
<!--<sup class="tag-count">4</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#stack">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkCyan;
        ">stack</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#rtt">
<span class="tag-name" style="
          font-size:0.6rem;
          color:DarkCyan;
        ">rtt</span>
<!--<sup class="tag-count">2</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#virtual">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkTurquoise;
        ">virtual</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#sysview">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkOliveGreen;
        ">sysview</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#python">
<span class="tag-name" style="
          font-size:0.75rem;
          color:DarkTurquoise;
        ">python</span>
<!--<sup class="tag-count">5</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#gpio">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkOliveGreen;
        ">gpio</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#css">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkOliveGreen;
        ">css</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#ros">
<span class="tag-name" style="
          font-size:0.6rem;
          color:DarkOliveGreen;
        ">ros</span>
<!--<sup class="tag-count">2</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#dma">
<span class="tag-name" style="
          font-size:0.6rem;
          color:DarkTurquoise;
        ">dma</span>
<!--<sup class="tag-count">2</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#swv">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkBlue;
        ">swv</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#arm">
<span class="tag-name" style="
          font-size:1.6500000000000001rem;
          color:DarkCyan;
        ">arm</span>
<!--<sup class="tag-count">23</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#mkdocs">
<span class="tag-name" style="
          font-size:0.65rem;
          color:DarkGoldenrod;
        ">mkdocs</span>
<!--<sup class="tag-count">3</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#usart">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkOliveGreen;
        ">usart</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#pwm">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkOrchid;
        ">pwm</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#capture">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkGoldenrod;
        ">capture</span>
<!--<sup class="tag-count">1</sup>-->
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#docs">
<span class="tag-name" style="
          font-size:0.55rem;
          color:DarkCyan;
        ">docs</span>
<!--<sup class="tag-count">1</sup>-->
</a>
</div>
</div>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<style>
            .md-typeset .cover {
                margin-bottom: 1em;
            }
            @media print {
                .md-typeset .cover {
                    height: 100vh;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                }
            }
        </style>
<div class="cover">
<h1 class="page-title">US-100 - Ultrasonic distance sensor</h1>
<p class="page-description">US-100 is one of popular distance sensor used in many projects. It has ranging distance up to 450 cm with 1 mm resolution in less then 15 degree of view angle. It also has temperature sensor to compensate the result. The US-100 is very similar to the popular HC-SR04 ultrasonic sensors, but it provides UART interface beside the Pulse Width mode.</p>
<p class="page-tags">
<a class="tag" href="https://www.codeinsideout.com/tags/#sensor">
<span class="tag-name">
                        #sensor
                    </span>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#uart">
<span class="tag-name">
                        #uart
                    </span>
</a>
</p>
<p class="md-source-date">
<hr style="margin-bottom: .5em;"/>
<small>
                            Last update:
                            <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_datetime">2021-08-17 10:23:58</span>
</small>
</p>
</div>
<style>
            .md-typeset .toc {
                display: none;
            }
            .md-typeset .toc label {
                display: none;
            }
            .md-typeset .toc .md-nav {
                font-size: unset;
                line-height: 1.6;
            }
            .md-typeset .toc .md-nav--secondary {
                margin-left: -2em;
            }
            .md-typeset .toc .md-nav__list {
                margin: 0;
            }
            .md-typeset .toc ul {
                list-style: none;
            }
            @media print {
                .md-typeset .toc {
                    display: block;
                    page-break-after: always;
                }
                .md-typeset .toc .md-nav__link {
                    color: var(--md-typeset-a-color);
                }
                .md-typeset .toc .md-nav__link.md-nav__link--active {
                    font-weight: unset;
                }
            }
        </style>
<div class="toc">
<h2>Table of Content</h2>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-us-100-ultrasonic-sensor">
    1. US-100 Ultrasonic sensor
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-lab-1-uart-mode">
    2. Lab 1: UART mode
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-lab-2-pulse-mode">
    3. Lab 2: Pulse mode
  </a>
<nav aria-label="3. Lab 2: Pulse mode" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#31-methods-to-read-a-pulse-width">
    3.1. Methods to read a pulse width.
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#32-use-input-capture">
    3.2. Use Input Capture
  </a>
<nav aria-label="3.2. Use Input Capture" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#321-enable-timer-and-input-capture">
    3.2.1. Enable Timer and Input Capture
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#322-generated-code">
    3.2.2. Generated code
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#323-user-code">
    3.2.3. User code
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
<div class="btn-actions screen-only">
<p><a class="md-button" href="..\..\..\pdfs\blog\stm32\sensor-us-100\stm32__US-100_Sensor.pdf"><span class="twemoji"><svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M5 20h14v-2H5m14-9h-4V3H9v6H5l7 7 7-7z"></path></svg></span>PDF</a><a class="md-button" href="https://github.com/vuquangtrong/STM32-Tutorials/blob/main/Archives/F051R8_US-100_UART.zip"><span class="twemoji"><svg viewbox="0 0 640 512" xmlns="http://www.w3.org/2000/svg"><path d="m278.9 511.5-61-17.7c-6.4-1.8-10-8.5-8.2-14.9L346.2 8.7c1.8-6.4 8.5-10 14.9-8.2l61 17.7c6.4 1.8 10 8.5 8.2 14.9L293.8 503.3c-1.9 6.4-8.5 10.1-14.9 8.2zm-114-112.2 43.5-46.4c4.6-4.9 4.3-12.7-.8-17.2L117 256l90.6-79.7c5.1-4.5 5.5-12.3.8-17.2l-43.5-46.4c-4.5-4.8-12.1-5.1-17-.5L3.8 247.2c-5.1 4.7-5.1 12.8 0 17.5l144.1 135.1c4.9 4.6 12.5 4.4 17-.5zm327.2.6 144.1-135.1c5.1-4.7 5.1-12.8 0-17.5L492.1 112.1c-4.8-4.5-12.4-4.3-17 .5L431.6 159c-4.6 4.9-4.3 12.7.8 17.2L523 256l-90.6 79.7c-5.1 4.5-5.5 12.3-.8 17.2l43.5 46.4c4.5 4.9 12.1 5.1 17 .6z"></path></svg></span> US-100 UART mode</a>
<a class="md-button" href="https://github.com/vuquangtrong/STM32-Tutorials/blob/main/Archives/F051R8_US-100_TIMER_Input_Capture.zip"><span class="twemoji"><svg viewbox="0 0 640 512" xmlns="http://www.w3.org/2000/svg"><path d="m278.9 511.5-61-17.7c-6.4-1.8-10-8.5-8.2-14.9L346.2 8.7c1.8-6.4 8.5-10 14.9-8.2l61 17.7c6.4 1.8 10 8.5 8.2 14.9L293.8 503.3c-1.9 6.4-8.5 10.1-14.9 8.2zm-114-112.2 43.5-46.4c4.6-4.9 4.3-12.7-.8-17.2L117 256l90.6-79.7c5.1-4.5 5.5-12.3.8-17.2l-43.5-46.4c-4.5-4.8-12.1-5.1-17-.5L3.8 247.2c-5.1 4.7-5.1 12.8 0 17.5l144.1 135.1c4.9 4.6 12.5 4.4 17-.5zm327.2.6 144.1-135.1c5.1-4.7 5.1-12.8 0-17.5L492.1 112.1c-4.8-4.5-12.4-4.3-17 .5L431.6 159c-4.6 4.9-4.3 12.7.8 17.2L523 256l-90.6 79.7c-5.1 4.5-5.5 12.3-.8 17.2l43.5 46.4c4.5 4.9 12.1 5.1 17 .6z"></path></svg></span> Us-100 Pulse width mode using Timer Input Capture</a></p>
</div>
<h2 id="1-us-100-ultrasonic-sensor">1. US-100 Ultrasonic sensor<a class="headerlink" href="#1-us-100-ultrasonic-sensor" title="Permanent link">⚓︎</a></h2>
<p>The US-100 Ultrasonic sensor is very similar to the popular HC-SR04, and even looks the same, but has a few extra tricks:</p>
<ul>
<li>Can run from 3V to 5V, so don’t need any logic level shifters or dividers.</li>
<li>Can use in “Pulse” mode (like on HC-SR04) or in “Serial UART” mode.</li>
<li>Range is about 2 cm to 450 cm away, but 10 cm to 250 cm will get the best results</li>
</ul>
<p>
<figure class="w50"><img src="us-100_front.png"/><figcaption>Ultrasonic sensor US-100</figcaption></figure>
</p>
<ul>
<li>
<p>When the jumper is in place, use a 9600-baud UART to communicate with the sensor:</p>
<ul>
<li>Send <code>0x55</code> and read back two bytes (16 bit value) that is mm distance</li>
<li>Send <code>0x50</code> to read the temperature in degrees C, with an offset of <em>-45</em> degrees</li>
<li>This mode works directly with a PC USB to Serial adapter.</li>
</ul>
</li>
<li>
<p>When the jumper on the back is removed, it acts like an HC-SR04 with a trigger and echo pin:</p>
<ul>
<li>The width of echo pulse is the time it takes for the ultrasonic sound to travel from the sensor to the object and back.</li>
<li>No temperature data is read out using the Pulse mode</li>
</ul>
</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Debug on UART1 using Redirection</p>
<p>For more convenient, below labs use <a href="../uart-redirection/">UART Redirection</a> technique to use the UART1 as the debug terminal, and use standard <code>printf()</code> function to output messages.</p>
</div>
<h2 id="2-lab-1-uart-mode">2. Lab 1: UART mode<a class="headerlink" href="#2-lab-1-uart-mode" title="Permanent link">⚓︎</a></h2>
<p>The UART2 interface is used to communicate with US-100. As mentioned in the US-100 specification, the UART should be at <strong>9600</strong> baud-rate, <strong>8</strong> bit, <strong>N</strong>o parity, and <strong>1</strong> bit stop. <mark>Note to use the interrupt mode to receive data</mark>.</p>
<table>
<thead>
<tr>
<th>MCU Pin</th>
<th>US-100 Pin</th>
</tr>
</thead>
<tbody>
<tr>
<td>PA2 (UART2TX)</td>
<td>Trigger/TX</td>
</tr>
<tr>
<td>PA3 (UART2RX)</td>
<td>Echo/RX</td>
</tr>
</tbody>
</table>
<p>Create variable to hold the states, trial counter, commands, and returned value:</p>
<div class="highlight"><pre><span></span><code><span class="k">enum</span> <span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">IDLE</span><span class="p">,</span><span class="w"> </span><span class="n">WAIT_DIST</span><span class="p">,</span><span class="w"> </span><span class="n">CALC_DIST</span><span class="p">,</span><span class="w"> </span><span class="n">WAIT_TEMP</span><span class="p">,</span><span class="w"> </span><span class="n">CALC_TEMP</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
<span class="kt">char</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IDLE</span><span class="p">;</span><span class="w"></span>
<span class="kt">char</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="kt">uint16_t</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">cmd_dist</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x55</span><span class="p">};</span><span class="w"></span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">cmd_temp</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x50</span><span class="p">};</span><span class="w"></span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
</code></pre></div>
<p>Then, in the main loop, process each state, note to use interrupt mode to receive data:</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IDLE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// send request to measure distance</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">"D?</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">HAL_UART_Transmit</span><span class="p">(</span><span class="n">US_100</span><span class="p">,</span><span class="w"> </span><span class="n">cmd_dist</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">HAL_MAX_DELAY</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">HAL_UART_Receive_IT</span><span class="p">(</span><span class="n">US_100</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="c1">// change state</span>
<span class="w">            </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WAIT_DIST</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CALC_DIST</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// calculate distance</span>
<span class="w">            </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">"D = %d mm</span><span class="se">\n\r</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="c1">// send request to get temperature</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">"T?</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">HAL_UART_Transmit</span><span class="p">(</span><span class="n">US_100</span><span class="p">,</span><span class="w"> </span><span class="n">cmd_temp</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">HAL_MAX_DELAY</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">HAL_UART_Receive_IT</span><span class="p">(</span><span class="n">US_100</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="c1">// change state</span>
<span class="w">            </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WAIT_TEMP</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CALC_TEMP</span><span class="p">){</span><span class="w"></span>
<span class="w">            </span><span class="c1">// calculate temperature</span>
<span class="w">            </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">45</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">"T = %d</span><span class="se">\n\r</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="c1">// change state</span>
<span class="w">            </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IDLE</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">HAL_Delay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// retry after 5 seconds</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">++</span><span class="k">try</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">"Re-try</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IDLE</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Finally, handle the interrupt callback by checking the state and set new state for the main loop:</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">HAL_UART_RxCpltCallback</span><span class="p">(</span><span class="n">UART_HandleTypeDef</span><span class="w"> </span><span class="o">*</span><span class="n">huart</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">huart</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">US_100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">WAIT_DIST</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CALC_DIST</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">WAIT_TEMP</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CALC_TEMP</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Compile and run on the board, use a logic analyzer to check how fast the US-100 can response for each command, and here is the result:</p>
<ul>
<li>Distance response time: &lt; 10 ms</li>
<li>Temperature response time: &lt; 5 ms</li>
</ul>
<p>
<figure><img src="us-100_output_uart_waveform.png"/><figcaption>Output of US-100</figcaption>
</figure>
</p>
<p>And on the debug terminal, the distance and temperature are printed in decimal value:</p>
<p>
<figure class="w70"><img src="us-100_output_uart.png"/><figcaption>Print output on terminal</figcaption></figure>
</p>
<h2 id="3-lab-2-pulse-mode">3. Lab 2: Pulse mode<a class="headerlink" href="#3-lab-2-pulse-mode" title="Permanent link">⚓︎</a></h2>
<p>Triggering the sensor to start operation is done by sending a short pulse to the TRIGGER pin, and it should be anything wider than 5uS. It can be even a few milliseconds. The module sends an ultrasonic signal, eight pulses of 40kHz square wave from the transmitter; the echo is then picked up by the receiver and outputs a waveform with a time period proportional to the distance.</p>
<p>The echo response pulse corresponds to the time it takes for the ultrasonic sound to travel from the sensor to the object and back. Hence, the distance is computed as:</p>
<div class="highlight"><pre><span></span><code>Distance = Pulse Width * Speed of Sound / 2 (m)
</code></pre></div>
<p>The actual speed of sound depends on the several environment factors, with temperature having most pronounced effect:</p>
<div class="highlight"><pre><span></span><code>Speed of Sound = 331.4 + 0.6T (m/s)
</code></pre></div>
<p>US-100 has built-in temperature compensation, so the distance formula is reduced to:</p>
<div class="highlight"><pre><span></span><code>Distance = Pulse width * 165.7 (m)
</code></pre></div>
<p>The pulse with is calculated by the timer counter divided by the counting frequency:</p>
<div class="highlight"><pre><span></span><code>Pulse width = Timer counter / Frequency
</code></pre></div>
<p>Therefore, the final equation is:</p>
<div class="highlight"><pre><span></span><code>Distance = Timer counter / Frequency * 165.7 (m)
         = Timer counter * 165700 / Frequency (mm)
</code></pre></div>
<h3 id="31-methods-to-read-a-pulse-width">3.1. Methods to read a pulse width.<a class="headerlink" href="#31-methods-to-read-a-pulse-width" title="Permanent link">⚓︎</a></h3>
<p><strong>GPIO Polling + Timer</strong></p>
<p>A very basic technique is to keep polling a GPIO input pin. The MCU will keep waiting until this pin goes HIGH, then it turns ON a timer module to start counting. And keep polling the input pin until it goes LOW, then the timer is turned OFF. The timer counter value will tell the echo pulse width.</p>
<div class="admonition warning no-title">
<p class="admonition-title"> </p>
<p>Polling the GPIO input pin is a time-wasting procedure that has a potential risk of freezing the entire system in case of sensor failure or whatever.</p>
</div>
<div class="new-page"></div>
<p><strong>Ext Interrupt + Timer</strong></p>
<p>An EXTI pin will be set to wait for a raising edge to start an internal timer. After the edge is captured, that will be set to wait for falling edge, while timer is counting. The 2<sup>nd</sup> interrupt will stop the timer, and the timer counter value will tell the echo pulse width.</p>
<p><strong>Timer Input Capture</strong></p>
<p>Use a Timer with Input Capture mode to capture the timer value at the rising edge of the input pin, then capture the timer value at the falling edge. The different value will tell the echo pulse width.</p>
<p><strong>Differential Double Input Capture</strong></p>
<p>When measuring extremely short pulses, differential double IC provides accuracy and precision. Use 2 ICU channels: one triggers on the rising edge and the other triggers on the falling edge. The different value will tell the echo pulse width.</p>
<p><strong>Timer Gate-Controlled</strong></p>
<p>One technique that also works really well in extremely short pulse measurements is timer gate-controlled. In this specific mode, the timer is allowed to count only when the gate is activated. The gate is driven by the input pin connected to the echo pin. The timer counter value will tell the echo pulse width.</p>
<h3 id="32-use-input-capture">3.2. Use Input Capture<a class="headerlink" href="#32-use-input-capture" title="Permanent link">⚓︎</a></h3>
<p>This method will use the TIM1 with Input Capture on the Channel 1. Here are steps to capture the Echo pulse:</p>
<ol>
<li>Enable TIM1 using Internal Clock source, Enable Input Capture on Channel 1</li>
<li>For the best resolution, do not set the Pre-scaler, and let timers counts in full range of 16-bit</li>
<li>Set the capture edge at the Rising edge</li>
<li>Start TIM1, Start Input Capture on Channel 1 in Interrupt mode</li>
<li>When Echo pulse goes high, handle the interrupt:<ol>
<li>Save the timer counter to T1</li>
<li>Set the capture edge at the Falling edge</li>
</ol>
</li>
<li>When Echo pulse goes low, handle the interrupt:<ol>
<li>Save the timer counter to T2<ol>
<li>Different time is the width of the pulse</li>
<li>Distance is calculated based on the pulse width and the tick interval of the clock</li>
</ol>
</li>
<li>Set the capture edge at the Rising edge to capture another pulse</li>
</ol>
</li>
</ol>
<h4 id="321-enable-timer-and-input-capture">3.2.1. Enable Timer and Input Capture<a class="headerlink" href="#321-enable-timer-and-input-capture" title="Permanent link">⚓︎</a></h4>
<p>Using IDE to enable the TIM1 in system peripherals:</p>
<ul>
<li>Select internal clock source, and choose Channel 1 to <em>Input Capture direct mode</em>, which also captures a Rising edge at startup.</li>
<li>Enable interrupts for both <em>break, update, trigger, communication</em> and <em>capture compare</em></li>
</ul>
<p>
<figure><img src="ide_setup_timer_input_capture.png"/><figcaption>Setup Timer with Input Capture</figcaption>
</figure>
</p>
<p>The pin wiring also needs to change:</p>
<table>
<thead>
<tr>
<th>MCU Pin</th>
<th>US-100 Pin</th>
</tr>
</thead>
<tbody>
<tr>
<td>PA1 (Output)</td>
<td>Trigger/TX</td>
</tr>
<tr>
<td>PA8 (TIM1_CH1 input capture)</td>
<td>Echo/RX</td>
</tr>
<tr>
<td>PC9 (Output)</td>
<td>Timer Capture</td>
</tr>
<tr>
<td>PC8 (Output)</td>
<td>Timer Overflow</td>
</tr>
</tbody>
</table>
<h4 id="322-generated-code">3.2.2. Generated code<a class="headerlink" href="#322-generated-code" title="Permanent link">⚓︎</a></h4>
<p>The function <code>MX_TIM1_Init()</code> is generated with below steps to set up the selected configs:</p>
<ol>
<li>Initialize TIM1 Base, including Pre-scaler, Counter Period, and Auto-Reload</li>
<li>Select the clock source</li>
<li>Initialize Input Capture mode and its settings: polarity, edge, filter</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">MX_TIM1_Init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">TIM_ClockConfigTypeDef</span><span class="w"> </span><span class="n">sClockSourceConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="n">TIM_MasterConfigTypeDef</span><span class="w"> </span><span class="n">sMasterConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="n">TIM_IC_InitTypeDef</span><span class="w"> </span><span class="n">sConfigIC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>

<span class="hll"><span class="w">  </span><span class="n">htim1</span><span class="p">.</span><span class="n">Instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TIM1</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="w">  </span><span class="n">htim1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">Prescaler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="w">  </span><span class="n">htim1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">CounterMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TIM_COUNTERMODE_UP</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="w">  </span><span class="n">htim1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">Period</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">65535</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="w">  </span><span class="n">htim1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">ClockDivision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TIM_CLOCKDIVISION_DIV1</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="w">  </span><span class="n">htim1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">RepetitionCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="w">  </span><span class="n">htim1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">AutoReloadPreload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TIM_AUTORELOAD_PRELOAD_ENABLE</span><span class="p">;</span><span class="w"></span>
</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">HAL_TIM_Base_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim1</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Error_Handler</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="hll"><span class="w">  </span><span class="n">sClockSourceConfig</span><span class="p">.</span><span class="n">ClockSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TIM_CLOCKSOURCE_INTERNAL</span><span class="p">;</span><span class="w"></span>
</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">HAL_TIM_ConfigClockSource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sClockSourceConfig</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Error_Handler</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="hll"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">HAL_TIM_IC_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim1</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="w">    </span><span class="n">Error_Handler</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">sMasterConfig</span><span class="p">.</span><span class="n">MasterOutputTrigger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TIM_TRGO_RESET</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">sMasterConfig</span><span class="p">.</span><span class="n">MasterSlaveMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TIM_MASTERSLAVEMODE_DISABLE</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">HAL_TIMEx_MasterConfigSynchronization</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sMasterConfig</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">!=</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Error_Handler</span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">sConfigIC</span><span class="p">.</span><span class="n">ICPolarity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TIM_INPUTCHANNELPOLARITY_RISING</span><span class="p">;</span><span class="w"></span>
<span class="hll"><span class="w">  </span><span class="n">sConfigIC</span><span class="p">.</span><span class="n">ICSelection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TIM_ICSELECTION_DIRECTTI</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="w">  </span><span class="n">sConfigIC</span><span class="p">.</span><span class="n">ICPrescaler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TIM_ICPSC_DIV1</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="w">  </span><span class="n">sConfigIC</span><span class="p">.</span><span class="n">ICFilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">HAL_TIM_IC_ConfigChannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sConfigIC</span><span class="p">,</span><span class="w"> </span><span class="n">TIM_CHANNEL_1</span><span class="p">)</span><span class="w"></span>
</span><span class="w">      </span><span class="o">!=</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Error_Handler</span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Two interrupt handlers are generated too, <code>TIM1_BRK_UP_TRG_COM_IRQHandler()</code> and <code>TIM1_CC_IRQHandler()</code> which will call to:</p>
<ul>
<li><code>HAL_TIM_IC_CaptureCallback()</code>: interrupt when input capture meets the capture edge</li>
<li><code>HAL_TIM_PeriodElapsedCallback()</code>: interrupt when counter finishes one cycle (from 0 to Auto-Reload value)</li>
</ul>
<h4 id="323-user-code">3.2.3. User code<a class="headerlink" href="#323-user-code" title="Permanent link">⚓︎</a></h4>
<p>There are some variables to hold the system states, timer counter values, and distance value.</p>
<div class="highlight"><pre><span></span><code><span class="k">enum</span> <span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">IDLE</span><span class="p">,</span><span class="w"> </span><span class="n">WAIT</span><span class="p">,</span><span class="w"> </span><span class="n">CALC</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IDLE</span><span class="p">;</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="kt">uint32_t</span><span class="w"> </span><span class="n">T1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="kt">uint32_t</span><span class="w"> </span><span class="n">T2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="kt">uint32_t</span><span class="w"> </span><span class="n">overflow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="kt">uint32_t</span><span class="w"> </span><span class="n">period</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="kt">uint32_t</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="kt">uint32_t</span><span class="w"> </span><span class="n">distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="kt">char</span><span class="w"> </span><span class="n">edge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// raising</span>
</code></pre></div>
<p>In the <code>main()</code> function, save the clock period, and start both base timer’s interrupt and input capture’s interrupt:</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">period</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__HAL_TIM_GET_AUTORELOAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">HAL_TIM_Base_Start_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim1</span><span class="p">);</span><span class="w"> </span><span class="c1">// to get PeriodElapsedCallback</span>
<span class="w">    </span><span class="n">HAL_TIM_IC_Start_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim1</span><span class="p">,</span><span class="w"> </span><span class="n">TIM_CHANNEL_1</span><span class="p">);</span><span class="w"> </span><span class="c1">// to get IC_CaptureCallback</span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{...}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><strong>Save capture time</strong></p>
<p>Application has to handle interrupts to save timer counter at each edge, to get overflow counter, and set correct state of system.</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">HAL_TIM_IC_CaptureCallback</span><span class="p">(</span><span class="n">TIM_HandleTypeDef</span><span class="w"> </span><span class="o">*</span><span class="n">htim</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">WAIT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">edge</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">T1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HAL_TIM_ReadCapturedValue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim1</span><span class="p">,</span><span class="w"> </span><span class="n">TIM_CHANNEL_1</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">__HAL_TIM_SET_CAPTUREPOLARITY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim1</span><span class="p">,</span><span class="w"> </span><span class="n">TIM_CHANNEL_1</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">TIM_INPUTCHANNELPOLARITY_FALLING</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">overflow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// start check if timer is overflow</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">T2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HAL_TIM_ReadCapturedValue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim1</span><span class="p">,</span><span class="w"> </span><span class="n">TIM_CHANNEL_1</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">__HAL_TIM_SET_CAPTUREPOLARITY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim1</span><span class="p">,</span><span class="w"> </span><span class="n">TIM_CHANNEL_1</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">TIM_INPUTCHANNELPOLARITY_RISING</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CALC</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">edge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">edge</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">HAL_GPIO_TogglePin</span><span class="p">(</span><span class="n">LED_CC_GPIO_Port</span><span class="p">,</span><span class="w"> </span><span class="n">LED_CC_Pin</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">HAL_TIM_PeriodElapsedCallback</span><span class="p">(</span><span class="n">TIM_HandleTypeDef</span><span class="w"> </span><span class="o">*</span><span class="n">htim</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">WAIT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">overflow</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">HAL_GPIO_TogglePin</span><span class="p">(</span><span class="n">LED_OV_GPIO_Port</span><span class="p">,</span><span class="w"> </span><span class="n">LED_OV_Pin</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><strong>Main loop</strong></p>
<p>The main loop checks the current state and do corresponding actions.</p>
<div class="admonition warning">
<p class="admonition-title">Overflow when calculating with big number</p>
<p>In Embedded system, calculating with big number can cause overflow and returns wrong result.
In this tutorial, timer counter is a 32-bit number, but when it is multiplied with 165700, it can cause overflow.</p>
<div class="highlight"><pre><span></span><code>Distance = Timer counter / Frequency * 165.7 (m)
         = Timer counter * 165700 / Frequency (mm)
</code></pre></div>
</div>
<div class="highlight"><pre><span></span><code><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IDLE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// trigger</span>
<span class="w">        </span><span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">TRIGGER_GPIO_Port</span><span class="p">,</span><span class="w"> </span><span class="n">TRIGGER_Pin</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_PIN_SET</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">HAL_Delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">HAL_GPIO_WritePin</span><span class="p">(</span><span class="n">TRIGGER_GPIO_Port</span><span class="p">,</span><span class="w"> </span><span class="n">TRIGGER_Pin</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_PIN_RESET</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="c1">// change state</span>
<span class="w">        </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WAIT</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CALC</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// use overflow in case pulse occurs when timer counter is overflow</span>
<span class="w">        </span><span class="n">T2</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">overflow</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">period</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">T1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"T =  %lu ~ %lu us</span><span class="se">\t</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">counter</span><span class="p">,</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">48000</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="c1">// calc. distance</span>
<span class="w">        </span><span class="n">distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1657</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">distance</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="p">(</span><span class="n">SystemCoreClock</span><span class="o">/</span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"D = %lu mm</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">distance</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="c1">// change state</span>
<span class="w">        </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IDLE</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">HAL_Delay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">++</span><span class="k">try</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IDLE</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="admonition note no-title">
<p class="admonition-title"> </p>
<p>Toggling a pin helps showing when interrupts happen.</p>
</div>
<p>Here is the output seen in a logic analyzer in a case that timer counter is overflow.</p>
<p>
<figure><img src="us-100_output_timer_ic_waveform.png"/><figcaption>Output of sensor is captured in timer</figcaption>
</figure>
</p>
<p>Using an UART port to print the calculated distance in a terminal:</p>
<p>
<figure><img src="us-100_output_timer_ic.png"/><figcaption>Output of calculated distance</figcaption>
</figure>
</p>
<div data-value="https://www.codeinsideout.com/blog/stm32/sensor-us-100/" id="page_url"></div>
<div data-value="blog/stm32/sensor-us-100/" id="page_identifier"></div>
<div>
<h2 id="__comments">Comments</h2>
<div id="disqus_thread"></div>
<script>var disqus_config = function () { this.page.url = "https://www.codeinsideout.com/blog/stm32/sensor-us-100/", this.page.identifier = "blog/stm32/sensor-us-100/" }; window.addEventListener("load", function () { var e = document, i = e.createElement("script"); i.src = "//vuquangtrong-github-io.disqus.com/embed.js", i.setAttribute("data-timestamp", +new Date), (e.head || e.body).appendChild(i) })</script>
</div>
</article>
</div>
</div>
<a class="md-top md-icon" data-md-component="top" data-md-state="hidden" href="#">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path></svg>
            Back to top
          </a>
</main>
<footer class="md-footer">
<nav aria-label="Footer" class="md-footer__inner md-grid">
<a aria-label="Previous: Timers" class="md-footer__link md-footer__link--prev" href="../timer/" rel="prev">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</div>
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Previous
              </span>
              Timers
            </div>
</div>
</a>
<a aria-label="Next: ADC" class="md-footer__link md-footer__link--next" href="../adc/" rel="next">
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Next
              </span>
              ADC
            </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
            © 2021 Code Inside Out <div style="display:none"><div>
</div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
          Material for MkDocs
        </a>
</div>
<div>
    using
    <a href="https://github.com/vuquangtrong/mkdocs-material-blog">
        MkDocs Material Blog
    </a>
    theme
</div>
</div>
</div>
<div class="md-footer-social">
<a class="md-footer-social__link" href="https://github.com/vuquangtrong" rel="noopener" target="_blank" title="vuquangtrong">
<svg viewbox="0 0 480 512" xmlns="http://www.w3.org/2000/svg"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"></path></svg>
</a>
<a class="md-footer-social__link" href="https://facebook.com/trongvq" rel="noopener" target="_blank" title="trongvq">
<svg viewbox="0 0 320 512" xmlns="http://www.w3.org/2000/svg"><path d="m279.14 288 14.22-92.66h-88.91v-60.13c0-25.35 12.42-50.06 52.24-50.06h40.42V6.26S260.43 0 225.36 0c-73.22 0-121.08 44.38-121.08 124.72v70.62H22.89V288h81.39v224h100.17V288z"></path></svg>
</a>
<a class="md-footer-social__link" href="https://www.linkedin.com/in/vqtrong" rel="noopener" target="_blank" title="vqtrong">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.instant", "navigation.tabs", "navigation.top", "header.autohide", "search.suggest", "search.highlight"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.709b4209.min.js", "version": null}</script>
<script src="../../../assets/javascripts/bundle.febc23d1.min.js"></script>
<script src="../../../assets/view-bigimg.js"></script>
<script src="../../../assets/extra.js"></script>
</body>
</html>